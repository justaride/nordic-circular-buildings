---
import Layout from '../layouts/Layout.astro';
import norwayData from '../../public/data/norway.json';

// Get all projects for client-side lookup
const allProjects = norwayData.projects;

// Strategy labels
const strategyLabels: Record<string, string> = {
  material_reuse: 'Material Reuse',
  adaptive_reuse: 'Adaptive Reuse',
  design_for_disassembly: 'Design for Disassembly',
  upcycling: 'Upcycling',
  recycled_content: 'Recycled Content',
  low_carbon_materials: 'Low Carbon Materials',
};
---

<Layout title="Compare Projects">
  <div class="max-w-7xl mx-auto">
    <!-- Back Navigation -->
    <a href={import.meta.env.BASE_URL} class="inline-flex items-center gap-2 text-gray-500 hover:text-gray-700 mb-6 transition-colors">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Dashboard
    </a>

    <h1 class="text-3xl font-bold text-gray-900 mb-6">Compare Projects</h1>

    <!-- No projects selected message -->
    <div id="no-selection" class="hidden bg-white rounded-xl border border-nordic-100 p-12 text-center">
      <svg class="mx-auto h-12 w-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
      </svg>
      <p class="text-lg font-medium text-gray-700">No projects selected for comparison</p>
      <p class="text-gray-500 mb-4">Go back to the dashboard and select projects to compare</p>
      <a href={import.meta.env.BASE_URL} class="inline-flex items-center gap-2 px-4 py-2 bg-nordic-500 text-white rounded-lg hover:bg-nordic-600 transition-colors">
        Select Projects
      </a>
    </div>

    <!-- Comparison Table -->
    <div id="comparison-container" class="hidden">
      <div class="bg-white rounded-xl border border-nordic-100 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr id="project-headers" class="bg-gray-50 border-b border-gray-100">
                <th class="p-4 text-left text-sm font-semibold text-gray-500 w-48">Property</th>
                <!-- Project columns will be added here -->
              </tr>
            </thead>
            <tbody id="comparison-body">
              <!-- Comparison rows will be added here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Metrics Comparison Chart -->
      <div class="mt-6 bg-white rounded-xl border border-nordic-100 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Metrics Comparison</h2>
        <canvas id="comparison-chart" height="120"></canvas>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ allProjects, strategyLabels }}>
  document.addEventListener('DOMContentLoaded', () => {
    // Get project IDs from URL
    const urlParams = new URLSearchParams(window.location.search);
    const ids = urlParams.get('ids')?.split(',') || [];

    const noSelection = document.getElementById('no-selection');
    const comparisonContainer = document.getElementById('comparison-container');
    const projectHeaders = document.getElementById('project-headers');
    const comparisonBody = document.getElementById('comparison-body');

    if (ids.length < 2) {
      noSelection?.classList.remove('hidden');
      return;
    }

    // Find selected projects
    const selectedProjects = ids
      .map((id) => allProjects.find((p) => p.id === id))
      .filter((p) => p !== undefined);

    if (selectedProjects.length < 2) {
      noSelection?.classList.remove('hidden');
      return;
    }

    comparisonContainer?.classList.remove('hidden');

    // Add project headers
    selectedProjects.forEach((project) => {
      const th = document.createElement('th');
      th.className = 'p-4 text-left min-w-64';
      th.innerHTML = `
        <div class="font-semibold text-gray-900">${project.name}</div>
        <div class="text-sm text-gray-500">${project.location?.city}</div>
      `;
      projectHeaders?.appendChild(th);
    });

    // Comparison rows configuration
    const rows = [
      {
        label: 'Status',
        getValue: (p) => p.status?.replace('_', ' ') || '—',
        highlight: false,
      },
      {
        label: 'Building Type',
        getValue: (p) => p.building_type?.replace('_', ' ') || '—',
        highlight: false,
      },
      {
        label: 'Year Completed',
        getValue: (p) => p.year_completed || '—',
        highlight: false,
      },
      {
        label: 'Gross Area',
        getValue: (p) => p.gross_area ? `${p.gross_area.toLocaleString()} m²` : '—',
        highlight: false,
      },
      {
        label: 'Circularity Rate',
        getValue: (p) => p.metrics?.circularity_rate?.value ? `${p.metrics.circularity_rate.value}%` : '—',
        highlight: true,
        highlightType: 'max',
        rawValue: (p) => p.metrics?.circularity_rate?.value || 0,
      },
      {
        label: 'CO₂ Reduction',
        getValue: (p) => p.metrics?.co2_reduction?.value ? `${p.metrics.co2_reduction.value}%` : '—',
        highlight: true,
        highlightType: 'max',
        rawValue: (p) => p.metrics?.co2_reduction?.value || 0,
      },
      {
        label: 'Reused Materials',
        getValue: (p) => {
          const m = p.metrics?.reused_materials;
          return m ? `${m.value}${m.unit}` : '—';
        },
        highlight: false,
      },
      {
        label: 'Primary Strategies',
        getValue: (p) => {
          if (!p.primary_strategies?.length) return '—';
          return p.primary_strategies
            .map((s) => strategyLabels[s] || s.replace('_', ' '))
            .join(', ');
        },
        highlight: false,
      },
      {
        label: 'Certifications',
        getValue: (p) => p.certifications?.join(', ') || '—',
        highlight: false,
      },
      {
        label: 'Developer',
        getValue: (p) => p.developer || '—',
        highlight: false,
      },
      {
        label: 'Architect',
        getValue: (p) => p.architect || '—',
        highlight: false,
      },
    ];

    // Generate comparison rows
    rows.forEach((row) => {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-gray-50 hover:bg-gray-50/50';

      // Label cell
      const labelTd = document.createElement('td');
      labelTd.className = 'p-4 text-sm font-medium text-gray-500';
      labelTd.textContent = row.label;
      tr.appendChild(labelTd);

      // Get values and find best for highlighting
      const values = selectedProjects.map((p) => ({
        display: row.getValue(p),
        raw: row.rawValue ? row.rawValue(p) : null,
      }));

      let bestIndex = -1;
      if (row.highlight && row.rawValue) {
        const rawValues = values.map((v) => v.raw);
        const maxVal = Math.max(...rawValues);
        if (maxVal > 0) {
          bestIndex = rawValues.indexOf(maxVal);
        }
      }

      // Value cells
      values.forEach((val, idx) => {
        const td = document.createElement('td');
        td.className = 'p-4 text-sm text-gray-900';
        if (idx === bestIndex) {
          td.innerHTML = `<span class="inline-flex items-center gap-1 px-2 py-1 bg-nordic-50 text-nordic-700 rounded-lg font-medium">
            ${val.display}
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
          </span>`;
        } else {
          td.textContent = val.display;
        }
        tr.appendChild(td);
      });

      comparisonBody?.appendChild(tr);
    });

    // Generate comparison chart
    if (typeof Chart !== 'undefined') {
      const ctx = document.getElementById('comparison-chart');
      if (ctx) {
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: selectedProjects.map((p) => p.name),
            datasets: [
              {
                label: 'Circularity Rate (%)',
                data: selectedProjects.map((p) => p.metrics?.circularity_rate?.value || 0),
                backgroundColor: '#228b66',
                borderRadius: 4,
              },
              {
                label: 'CO₂ Reduction (%)',
                data: selectedProjects.map((p) => p.metrics?.co2_reduction?.value || 0),
                backgroundColor: '#2d7fc0',
                borderRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'top',
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
              },
            },
          },
        });
      }
    }
  });
</script>
