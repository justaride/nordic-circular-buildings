---
import Layout from '../../layouts/Layout.astro';

// Load enablers data
import enablersData from '../../../../data/enablers/norway.json';

interface EnablerLocation {
  city?: string;
  district?: string;
}

interface Enabler {
  name: string;
  full_name?: string;
  description?: string;
  status?: string;
  location?: EnablerLocation;
  founded?: string | number;
  website?: string;
  services?: string[];
  services_for_reuse?: string[];
  platform_features?: string[];
  projects?: string[];
  key_project_involvement?: string[];
  certified_projects?: string[];
}

interface EnablerCategory {
  id: string;
  name: string;
  description: string;
  enablers: Enabler[];
}

interface MaterialFlow {
  from_project: string;
  to_project: string;
  materials: string[];
  note?: string;
}

interface EmergingRole {
  name: string;
  norwegian?: string;
  description: string;
}

interface EnablersDataType {
  categories: EnablerCategory[];
  material_flows: { flows: MaterialFlow[] };
  emerging_roles: {
    roles: EmergingRole[];
    source: { title: string; research_id: string };
  };
  last_updated: string;
}

const data = enablersData as EnablersDataType;
const categories = data.categories;
const materialFlows = data.material_flows;
const emergingRoles = data.emerging_roles;

// Count totals
const totalEnablers = categories.reduce((sum, cat) => sum + cat.enablers.length, 0);

// Category icons mapping
const categoryIcons: Record<string, string> = {
  material_banks: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />`,
  digital_platforms: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />`,
  testing_certification: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />`,
  program_frameworks: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />`,
  consultants_specialists: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />`,
  contractors: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />`,
  standards_regulations: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />`,
  research_networks: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />`,
};

// Category colors
const categoryColors: Record<string, { bg: string; text: string; border: string }> = {
  material_banks: { bg: 'bg-emerald-50', text: 'text-emerald-700', border: 'border-emerald-200' },
  digital_platforms: { bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-200' },
  testing_certification: { bg: 'bg-purple-50', text: 'text-purple-700', border: 'border-purple-200' },
  program_frameworks: { bg: 'bg-amber-50', text: 'text-amber-700', border: 'border-amber-200' },
  consultants_specialists: { bg: 'bg-cyan-50', text: 'text-cyan-700', border: 'border-cyan-200' },
  contractors: { bg: 'bg-orange-50', text: 'text-orange-700', border: 'border-orange-200' },
  standards_regulations: { bg: 'bg-slate-50', text: 'text-slate-700', border: 'border-slate-200' },
  research_networks: { bg: 'bg-pink-50', text: 'text-pink-700', border: 'border-pink-200' },
};
---

<Layout title="Enablers" description="The ecosystem enabling circular construction in Norway - material banks, digital platforms, testing bodies, and program frameworks">
  <div class="max-w-7xl mx-auto px-6 py-8">
    <!-- Header -->
    <div class="mb-8">
      <a href={import.meta.env.BASE_URL} class="inline-flex items-center gap-1.5 text-gray-400 hover:text-gray-600 mb-4 text-sm transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Dashboard
      </a>
      <h1 class="text-2xl font-semibold text-gray-900 mb-2">Circular Construction Enablers</h1>
      <p class="text-gray-500 max-w-3xl">
        The ecosystem that makes circular construction possible in Norway â€” material banks, digital platforms,
        testing bodies, program frameworks, and specialist expertise.
      </p>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white rounded-2xl p-5 card-hover">
        <div class="text-2xl font-semibold text-gray-900 stat-number">{totalEnablers}</div>
        <div class="text-xs text-gray-400">Total Enablers</div>
      </div>
      <div class="bg-white rounded-2xl p-5 card-hover">
        <div class="text-2xl font-semibold text-gray-900 stat-number">{categories.length}</div>
        <div class="text-xs text-gray-400">Categories</div>
      </div>
      <div class="bg-white rounded-2xl p-5 card-hover">
        <div class="text-2xl font-semibold text-gray-900 stat-number">{materialFlows.flows.length}</div>
        <div class="text-xs text-gray-400">Material Flows</div>
      </div>
      <div class="bg-white rounded-2xl p-5 card-hover">
        <div class="text-2xl font-semibold text-gray-900 stat-number">{emergingRoles.roles.length}</div>
        <div class="text-xs text-gray-400">Emerging Roles</div>
      </div>
    </div>

    <!-- Category Navigation -->
    <div class="bg-white rounded-2xl p-4 mb-8 card-hover">
      <div class="flex flex-wrap gap-2">
        {categories.map((category) => {
          const colors = categoryColors[category.id] || { bg: 'bg-gray-50', text: 'text-gray-700', border: 'border-gray-200' };
          return (
            <a
              href={`#${category.id}`}
              class={`px-3 py-1.5 rounded-lg text-sm font-medium ${colors.bg} ${colors.text} border ${colors.border} hover:opacity-80 transition-opacity`}
            >
              {category.name} ({category.enablers.length})
            </a>
          );
        })}
      </div>
    </div>

    <!-- Categories Grid -->
    <div class="space-y-8">
      {categories.map((category) => {
        const colors = categoryColors[category.id] || { bg: 'bg-gray-50', text: 'text-gray-700', border: 'border-gray-200' };
        const icon = categoryIcons[category.id] || categoryIcons.material_banks;

        return (
          <section id={category.id} class="scroll-mt-20">
            <div class={`rounded-2xl border ${colors.border} overflow-hidden`}>
              <!-- Category Header -->
              <div class={`${colors.bg} px-6 py-4 border-b ${colors.border}`}>
                <div class="flex items-center gap-3">
                  <div class={`w-10 h-10 rounded-xl ${colors.bg} border ${colors.border} flex items-center justify-center`}>
                    <svg class={`w-5 h-5 ${colors.text}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" set:html={icon} />
                  </div>
                  <div>
                    <h2 class="text-lg font-semibold text-gray-900">{category.name}</h2>
                    <p class="text-sm text-gray-500">{category.description}</p>
                  </div>
                </div>
              </div>

              <!-- Enablers Grid -->
              <div class="bg-white p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {category.enablers.map((enabler: Enabler) => (
                    <div class="p-4 bg-gray-50/50 rounded-xl hover:bg-gray-50 transition-colors">
                      <div class="flex items-start justify-between gap-2 mb-2">
                        <h3 class="font-medium text-gray-900">{enabler.name}</h3>
                        {enabler.status && (
                          <span class={`px-2 py-0.5 rounded text-xs ${
                            enabler.status === 'operational' ? 'bg-green-100 text-green-700' :
                            enabler.status === 'under_development' ? 'bg-amber-100 text-amber-700' :
                            'bg-gray-100 text-gray-600'
                          }`}>
                            {enabler.status.replace('_', ' ')}
                          </span>
                        )}
                      </div>

                      {enabler.full_name && enabler.full_name !== enabler.name && (
                        <p class="text-xs text-gray-400 mb-2">{enabler.full_name}</p>
                      )}

                      {enabler.description && (
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">{enabler.description}</p>
                      )}

                      {/* Location */}
                      {enabler.location?.city && (
                        <div class="flex items-center gap-1.5 text-xs text-gray-400 mb-2">
                          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                          </svg>
                          {enabler.location.city}{enabler.location.district ? `, ${enabler.location.district}` : ''}
                        </div>
                      )}

                      {/* Founded */}
                      {enabler.founded && (
                        <div class="flex items-center gap-1.5 text-xs text-gray-400 mb-2">
                          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                          {typeof enabler.founded === 'string' ? `Since ${enabler.founded}` : `Est. ${enabler.founded}`}
                        </div>
                      )}

                      {/* Services/Features */}
                      {(enabler.services || enabler.services_for_reuse || enabler.platform_features) && (
                        <div class="flex flex-wrap gap-1 mt-3">
                          {(enabler.services || enabler.services_for_reuse || enabler.platform_features || []).slice(0, 3).map((service: string) => (
                            <span class="px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded text-xs truncate max-w-[120px]" title={service}>
                              {service}
                            </span>
                          ))}
                          {(enabler.services || enabler.services_for_reuse || enabler.platform_features || []).length > 3 && (
                            <span class="px-1.5 py-0.5 bg-gray-100 text-gray-400 rounded text-xs">
                              +{(enabler.services || enabler.services_for_reuse || enabler.platform_features).length - 3}
                            </span>
                          )}
                        </div>
                      )}

                      {/* Projects */}
                      {enabler.projects && enabler.projects.length > 0 && (
                        <div class="mt-3 pt-3 border-t border-gray-100">
                          <div class="text-xs text-gray-400">
                            {enabler.projects.length} documented project{enabler.projects.length !== 1 ? 's' : ''}
                          </div>
                        </div>
                      )}

                      {/* Key project involvement */}
                      {enabler.key_project_involvement && enabler.key_project_involvement.length > 0 && (
                        <div class="mt-3 pt-3 border-t border-gray-100">
                          <div class="text-xs text-gray-400">
                            Involved in {enabler.key_project_involvement.length} project{enabler.key_project_involvement.length !== 1 ? 's' : ''}
                          </div>
                        </div>
                      )}

                      {/* Certified projects */}
                      {enabler.certified_projects && enabler.certified_projects.length > 0 && (
                        <div class="mt-3 pt-3 border-t border-gray-100">
                          <div class="text-xs text-gray-400">
                            {enabler.certified_projects.length} certified project{enabler.certified_projects.length !== 1 ? 's' : ''}
                          </div>
                        </div>
                      )}

                      {/* Website */}
                      {enabler.website && (
                        <a
                          href={enabler.website}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="mt-3 inline-flex items-center gap-1 text-xs text-nordic-600 hover:text-nordic-700"
                        >
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                          </svg>
                          Website
                        </a>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </section>
        );
      })}
    </div>

    <!-- Material Flows Section -->
    <section class="mt-12">
      <div class="bg-gradient-to-br from-nordic-50 to-fjord-50 rounded-2xl border border-nordic-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-nordic-100">
          <h2 class="text-lg font-semibold text-gray-900">Documented Material Flows</h2>
          <p class="text-sm text-gray-500">Known transfers between donor buildings and recipient projects</p>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {materialFlows.flows.map((flow: MaterialFlow) => (
              <div class="bg-white rounded-xl p-4 border border-gray-100">
                <div class="flex items-center gap-2 mb-2">
                  <span class="font-medium text-gray-900">{flow.from_project}</span>
                  <svg class="w-4 h-4 text-nordic-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                  </svg>
                  <span class="font-medium text-gray-900">{flow.to_project}</span>
                </div>
                <div class="flex flex-wrap gap-1 mb-2">
                  {flow.materials.map((material: string) => (
                    <span class="px-2 py-0.5 bg-nordic-100 text-nordic-700 rounded text-xs">{material}</span>
                  ))}
                </div>
                {flow.note && (
                  <p class="text-xs text-gray-400">{flow.note}</p>
                )}
              </div>
            ))}
          </div>
        </div>
      </div>
    </section>

    <!-- Emerging Roles Section -->
    <section class="mt-8">
      <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden card-hover">
        <div class="px-6 py-4 border-b border-gray-100">
          <h2 class="text-lg font-semibold text-gray-900">Emerging Roles in Circular Construction</h2>
          <p class="text-sm text-gray-500">
            New professional roles identified from Swedish research, applicable to the Norwegian market
          </p>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {emergingRoles.roles.map((role: EmergingRole) => (
              <div class="p-4 bg-gray-50/50 rounded-xl">
                <h3 class="font-medium text-gray-900 mb-1">{role.name}</h3>
                {role.norwegian && (
                  <p class="text-xs text-nordic-600 mb-2">{role.norwegian}</p>
                )}
                <p class="text-sm text-gray-600">{role.description}</p>
              </div>
            ))}
          </div>
          <div class="mt-4 pt-4 border-t border-gray-100">
            <p class="text-xs text-gray-400">
              Source: <em>{emergingRoles.source.title}</em> (Research ID: {emergingRoles.source.research_id})
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Data Source Note -->
    <div class="mt-8 p-4 bg-gray-50 rounded-xl text-sm text-gray-500">
      <p>
        <strong>Data source:</strong> Compiled from official project reports (erfaringsrapporter),
        FutureBuilt documentation, Klimasats reports, and web research.
        Last updated: {data.last_updated}
      </p>
    </div>
  </div>
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
